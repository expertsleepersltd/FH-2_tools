<!DOCTYPE html>
<head>

<title>FH-2 Preset Tool</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Mono">

<style>
body {
}
button {
}
select {
}
tr.a {
	background-color: #e0e0e0;
}
th {
	background-color: #c0c0c0;
	font-size: 80%;
}
td.tc {
	text-align: center;
	background-color: #c0c0c0;
	font-size: 80%;
}
td.tc_a {
	text-align: center;
	background-color: #e0e0e0;
	font-size: 80%;
}
input {
}
textarea {
    font-family: 'PT Mono', monospace;
	font-size: 11px;
}
body {
	font-family: 'PT Sans', serif;
	font-size: 16px;
}
button.big {
	font-size: 120%;
}
input, select, button {
	font-family: 'PT Sans', serif;
	font-size: 11px;
}
div.small {
	font-size: 80%;
}
div.warning {
	background: salmon;
	text-align: center;
}
table {
	margin-bottom: 5px;
}
div.tc_c {
	font-size: 80%;
}
div.rth {
	-webkit-writing-mode: vertical-rl;
	transform: rotate(200deg);
	padding-left: 5px;
	padding-right: 5px;
}
table.logs {
	margin: 0px;
	border-spacing: 0px;
}
table.nested {
	margin: 0px;
}
td.logs {
	padding: 0px;
}
label.logs {
	font-size: 80%;
}
.hidden {
	position:absolute;
	left:-10000px;
	top:auto;
	width:1px;
	height:1px;
	overflow:hidden;
}
p {
	margin-block-start: 0em;
	margin-block-end: 0em;
}
div.relative_cb {
	display:inline;
}
input.relative_cb {
	margin:0px;
}
div.upload {
	border: 1px;
	border-style: dotted;
	display: inline-block;
}
</style>

<script>
function changeTheme() {
	let stylesheet = document.styleSheets[2];
	if ( document.getElementById( "theme" ).value == 0 ) {
		// body
		stylesheet.cssRules[0].style.setProperty('background-color', 'white');
		stylesheet.cssRules[0].style.setProperty('color', 'black');
		// button
		stylesheet.cssRules[1].style.setProperty('background-color', '#efefef');
		stylesheet.cssRules[1].style.setProperty('color', 'black');
		// select
		stylesheet.cssRules[2].style.setProperty('background-color', 'white');
		stylesheet.cssRules[2].style.setProperty('color', 'black');
		// tr.a
		stylesheet.cssRules[3].style.setProperty('background-color', '#e0e0e0');
		// th
		stylesheet.cssRules[4].style.setProperty('background-color', '#c0c0c0');
		// td.tc
		stylesheet.cssRules[5].style.setProperty('background-color', '#c0c0c0');
		// td.tc_a
		stylesheet.cssRules[6].style.setProperty('background-color', '#e0e0e0');
		// input
		stylesheet.cssRules[7].style.setProperty('background-color', 'white');
		stylesheet.cssRules[7].style.setProperty('color', 'black');
		// textarea
		stylesheet.cssRules[8].style.setProperty('background-color', 'white');
		stylesheet.cssRules[8].style.setProperty('color', 'black');
	} else {
		// body
		stylesheet.cssRules[0].style.setProperty('background-color', 'black');
		stylesheet.cssRules[0].style.setProperty('color', '#c0c0c0');
		// button
		stylesheet.cssRules[1].style.setProperty('background-color', 'black');
		stylesheet.cssRules[1].style.setProperty('color', '#c0c0c0');
		// select
		stylesheet.cssRules[2].style.setProperty('background-color', 'black');
		stylesheet.cssRules[2].style.setProperty('color', '#c0c0c0');
		// tr.a
		stylesheet.cssRules[3].style.setProperty('background-color', '#505050');
		// th
		stylesheet.cssRules[4].style.setProperty('background-color', '#505050');
		// td.tc
		stylesheet.cssRules[5].style.setProperty('background-color', '#505050');
		// td.tc_a
		stylesheet.cssRules[6].style.setProperty('background-color', '#606060');
		// input
		stylesheet.cssRules[7].style.setProperty('background-color', 'black');
		stylesheet.cssRules[7].style.setProperty('color', '#c0c0c0');
		// textarea
		stylesheet.cssRules[8].style.setProperty('background-color', 'black');
		stylesheet.cssRules[8].style.setProperty('color', '#c0c0c0');
	}
    localStorage.setItem( themeKey, document.getElementById( "theme" ).value );
}
function log( t ) {
	var ta = document.getElementById( "log" );
	var d = new Date();
	var dd = d.toLocaleTimeString();
	ta.value = ta.value + "\n" + dd + ": " + t;
	ta.scrollTop = ta.scrollHeight;
	return dd;
}
function status( t ) {
    document.getElementById( "status" ).innerHTML = "Web MIDI status: " + t;
}
function nybbleChar( n ) {
	if ( n >= 10 ) {
		return String.fromCharCode( 'A'.charCodeAt( 0 ) + n - 10 );
	}
	return String.fromCharCode( '0'.charCodeAt( 0 ) + n );
}
function unSysexSafeInt( v ) {
	return ( v & 0x7f ) | ( ( v >> 1 ) & 0x3f80 ) | ( ( v >> 2 ) & 0x1FC000 ) | ( ( v >> 3 ) & 0xFE00000 );
}
function sysexSafeShort( v ) {
	return ( v & 0x7f ) | ( ( v << 1 ) & 0x7f00 );
}
function unSysexSafeShort( v ) {
	return ( v & 0x7f ) | ( ( v >> 1 ) & 0x3f80 );
}
function unSysexSafeSignedShort( v ) {
	var s = ( v & 0x7f ) | ( ( v >> 1 ) & 0x3f80 );
	if ( s & 0x2000 ) {
		s = s - 16384;
	}
	return s;
}
function sysexSafeSignedChar( v ) {
	return v & 0x7f;
}
function unSysexSafeSignedChar( v ) {
	if ( v & 0x40 ) {
		return v - 128;
	}
	return v;
}
function makeSysEx() {
	var arr = new Uint8Array( 8192 );
	var d = [0xF0, 0x00, 0x21, 0x27, 0x2F, 0x13, 0x00, 0x00]
	var len = d.length
	for ( var i = 0; i < len; ++i ) {
		arr[i] = d[i];
	} 
	var c = len;
	// version
	arr[c] = 7;	 	 c += 1;
	arr[c] = 0;		 c += 1;
	arr[c] = 0;		 c += 1;
	arr[c] = 0;		 c += 1;
	// name
	var name = document.getElementById( "config_name" ).value;
	name += "                ";
	name = name.substring( 0, 16 );
	for ( var i = 0; i < 16; ++i ) {
		arr[c+i] = name.charCodeAt( i );
	}
	c += 17;
	// globals
	arr[c] = document.getElementById( "swing_type" ).value;	c += 1;
	arr[c] = document.getElementById( "swing_amount" ).value;	c += 1;
	c += 1;
	// fader levels
	for ( i = 0; i < 64; ++i ) {
		let v = document.getElementById( "out_" + i + "_DC" ).value;
		arr[c] = v & 0x7f;		 		c += 1;
		arr[c] = ( v >> 7 ) & 0x7f;		c += 1;
	}
	// LFOs
	for ( i = 0; i < 64; ++i ) {
		let v = document.getElementById( "out_" + i + "_MLT" ).value;
		arr[c] = v & 0x7f;		 		c += 1;
		arr[c] = ( v >> 7 ) & 0x7f;		c += 1;
		v = document.getElementById( "out_" + i + "_LFO" ).value;
		arr[c] = v & 0x7f;		 		c += 1;
		arr[c] = ( v >> 7 ) & 0x7f;		c += 1;

		arr[c] = document.getElementById( "out_" + i + "_CLK" ).value;		c += 1;
		arr[c] = document.getElementById( "out_" + i + "_CLKM" ).value;	c += 1;

		arr[c] = document.getElementById( "out_" + i + "_SIN" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_SQR" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_TRI" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_PW" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_SAW" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_RND" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_NSE" ).value;	c += 1;

		arr[c] = document.getElementById( "out_" + i + "_FAD" ).value;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_MUS" ).checked;	c += 1;
		arr[c] = document.getElementById( "out_" + i + "_PHS" ).value;	c += 1;
	}
	// smoothing
	for ( i = 0; i < 64; ++i ) {
		arr[c] = document.getElementById( "out_" + i + "_SMO" ).value;	c += 1;
	}
	// MCV mappable
	for ( i = 0; i < 16; ++i ) {
		arr[c] = document.getElementById( "arpeg" + i + "_M" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_R" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_G" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_L" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_T" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_P" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_S" ).value;	c += 1;
		arr[c] = document.getElementById( "arpeg" + i + "_E" ).value;	c += 1;
	}
	// globals
	let v = Math.round( document.getElementById( "tempo" ).value * 10.0 );
	arr[c] = v & 0x7f;		 		c += 1;
	arr[c] = ( v >> 7 ) & 0x7f;		c += 1;
	arr[c] = ( v >> 14 ) & 0x7f;	c += 1;
	arr[c] = ( v >> 21 ) & 0x7f;	c += 1;
	// euclidean
	for ( i = 0; i < 16; ++i ) {
		arr[c] = document.getElementById( "euc_" + i + "_P" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_S" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_R" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_T" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_G" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_A" ).value;	c += 1;
		arr[c] = document.getElementById( "euc_" + i + "_E" ).value;	c += 1;
		c += 1;
	}
	// MCV mappable 2
	for ( i = 0; i < 16; ++i ) {
		arr[c] = document.getElementById( "mcvm2_" + i + "_A" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_D" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_S" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_R" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_N" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_P" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_V" ).value;	c += 1;
		arr[c] = document.getElementById( "mcvm2_" + i + "_RND" ).value;	c += 1;
	}
	// scala
	for ( i = 0; i < 16; ++i ) {
		arr[c] = document.getElementById( "scala_" + i + "_enable" ).value;	c += 1;
		arr[c] = document.getElementById( "scala_" + i + "_scl" ).value;		c += 1;
		arr[c] = document.getElementById( "scala_" + i + "_kbm" ).value;		c += 1;
		c += 1;
	}
	// sequencer active/mute
	let sa = 0;
	let sm = 0;
	for ( i = 0; i < 4; ++i ) {
		sa |= document.getElementById( "seq_" + i + "_active" ).checked << i;
		sm |= document.getElementById( "seq_" + i + "_mute" ).checked << i;
	}
	arr[c] = sa;	c += 1;
	arr[c] = sm;	c += 1;
	let da = 0;
	let dm = 0;
	for ( i = 0; i < 1; ++i ) {
		da |= document.getElementById( "dseq_" + i + "_active" ).checked << i;
		dm |= document.getElementById( "dseq_" + i + "_mute" ).checked << i;
	}
	arr[c] = da;	c += 1;
	arr[c] = dm;	c += 1;
	// triggers
	c += 8;
	// seqencers
	let patterns = [ [], [], [], [] ];
	for ( i = 0; i < 4; ++i ) {
		let pattern = [];
		for ( let j=0; j<32; ++j ) {
			let v = 0;
			for ( let k=0; k<8; ++k ) {
				v |= ( document.getElementById( "seq_" + i + "_" + j + "_" + k ).value & 3 ) << (2*k);
			}
			pattern[j] = v;
			arr[c] = v & 0x7f;		 		c += 1;
			arr[c] = ( v >> 7 ) & 0x7f;		c += 1;
			let v0 = 0;
			let v1 = 0;
			v0 |= document.getElementById( "seq_" + i + "_" + j + "_degree" ).value & 0xf;
			v0 |= ( document.getElementById( "seq_" + i + "_" + j + "_octave" ).value & 0x7 ) << 4;
			v1 |= document.getElementById( "seq_" + i + "_" + j + "_length" ).value & 0x7;
			v1 |= document.getElementById( "seq_" + i + "_" + j + "_ratchet" ).checked << 3;
			v1 |= document.getElementById( "seq_" + i + "_" + j + "_reset" ).checked << 4;
			arr[c] = v0;	c += 1;
			arr[c] = v1;	c += 1;
		}
		arr[c] = document.getElementById( "seq_" + i + "_A" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_E" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_T" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_G" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_S" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_N" ).value;	c += 1;
		arr[c] = document.getElementById( "seq_" + i + "_D" ).value;	c += 1;
		c += 1;
		patterns[i] = pattern;
	}
	// drum seqencers
	for ( i = 0; i < 1; ++i ) {
		for ( let j=0; j<8; ++j ) {
			for ( let m=0; m<4; ++m ) {
				let h = 0;
				for ( let n=0; n<4; ++n ) {
    				h |= document.getElementById( "dseqh" + i + "_" + j + "_" + (m*8+n) ).checked << n;
    			}
    			arr[c] = h;	c += 1;
			}
			for ( let m=0; m<4; ++m ) {
				let a = 0;
				for ( let n=0; n<4; ++n ) {
	    			a |= document.getElementById( "dseqa" + i + "_" + j + "_" + (m*8+n) ).checked << n;
    			}
    			arr[c] = a;	c += 1;
			}
			arr[c] = document.getElementById( "dseq" + i + "_" + j + "_A" ).value;	c += 1;
			arr[c] = document.getElementById( "dseq" + i + "_" + j + "_E" ).value;	c += 1;
			arr[c] = document.getElementById( "dseq" + i + "_" + j + "_T" ).value;	c += 1;
			arr[c] = document.getElementById( "dseq" + i + "_" + j + "_S" ).value;	c += 1;
			arr[c] = document.getElementById( "dseq" + i + "_" + j + "_M" ).checked;	c += 1;
			c += 3;
		}
		arr[c] = document.getElementById( "dseq" + i + "_S" ).value;	c += 1;
		c += 15;
	}
	// shift reg random
	for ( i = 0; i < 16; ++i ) {
		arr[c] = document.getElementById( "srr_" + i + "_D" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_L" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_R" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_T" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_A" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_S" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_K" ).value;	c += 1;
		arr[c] = document.getElementById( "srr_" + i + "_G" ).value;	c += 1;
	}
	// swing
	arr[c] = document.getElementById( "swing_pos1" ).value;	c += 1;
	arr[c] = document.getElementById( "swing_pos2" ).value;	c += 1;
	arr[c] = document.getElementById( "swing_pos3" ).value;	c += 1;
	c += 1;

	// pad to 4096 bytes
	while ( ( c - len ) < 4096 ) {
		arr[c] = 0;		 c += 1;
	}
	
	// addendum
	
	// triggers	
	for ( i = 0; i < 16; ++i ) {
		let v = 0;
		for ( let j=0; j<4; ++j ) {
			v |= document.getElementById( "trig_" + (i*4+j) ).checked << j;
		}
		arr[c] = v; 	c += 1;
	}
	// seqencers
	for ( i = 0; i < 4; ++i ) {
		arr[c] = document.getElementById( "seq_" + i + "_P" ).value;	c += 1;
    	let pattern = patterns[i];
		for ( let j=0; j<32; ++j ) {
			let p = pattern[j];
			arr[c] = ( p >> 14 ) & 0x3;	c += 1;
			let v1 = 0;
			v1 |= document.getElementById( "seq_" + i + "_" + j + "_skip" ).checked;
			v1 |= ( document.getElementById( "seq_" + i + "_" + j + "_mute" ).value & 0x7 ) << 1;
			arr[c] = v1;	c += 1;
		}
	}
	// drum seqencers
	for ( i = 0; i < 1; ++i ) {
		for ( let j=0; j<8; ++j ) {
			for ( let m=0; m<4; ++m ) {
				let h = 0;
				for ( let n=0; n<4; ++n ) {
    				h |= document.getElementById( "dseqh" + i + "_" + j + "_" + (m*8+4+n) ).checked << n;
    			}
    			arr[c] = h;	c += 1;
			}
			for ( let m=0; m<4; ++m ) {
				let a = 0;
				for ( let n=0; n<4; ++n ) {
	    			a |= document.getElementById( "dseqa" + i + "_" + j + "_" + (m*8+4+n) ).checked << n;
    			}
    			arr[c] = a;	c += 1;
			}
		}
	}

	arr[c] = 0xF7; c += 1;

	return arr.subarray( 0, c );
}
function makeMsgSysEx() {
	var d = [0xF0, 0x00, 0x21, 0x27, 0x2F, 0x02]
	var len = d.length
	var str = ""
	for ( var i = 0; i < len; ++i ) {
		str += String.fromCharCode( d[i] );
	} 
	var text = "Hello!\nThis message\nwas sent from\nthe preset tool.";
	str += text;
	str += String.fromCharCode( 0xF7 );
	return str;
}
function dumpSysex( data, id, prefix ) {
	var len = data.length
	var h = prefix
	for ( var i = 0; i < len; ++i ) {
		var b = data[ i ];
		h += nybbleChar( b >> 4 );
		h += nybbleChar( b & 0xf );
		h += " ";
		if ( ( i & 0xf ) === 0xf ) {
			h += "\n";
		}
	} 
	document.getElementById( id ).value = h;
}
</script>

<script>
var arpControls = [ "M", "R", "G", "L", "T", "P", "S", "E" ];
var arpControlsUI = [ "P", "E" ];
var arpControlsUI2 = [ "M", "R", "G", "L", "T", "S" ];
var mcvMappable2Controls = [ "A", "D", "S", "R", "N", "P", "V", "RND" ];
var eucControls = [ "P", "S", "R", "T", "G", "A", "E" ];
var srrControls = [ "D", "L", "R", "T", "A", "S", "K", "G" ];
var menus = [ 'C', 'D', 'E' ];
var menuCCs = [ 80, 88, 96 ];
var unhandled = [];
function hex( b ) {
	h = nybbleChar( b >> 4 );
	h += nybbleChar( b & 0xf );
	return h;
}

function showHide( id, show ) {
	var ta = document.getElementById( id );
	ta.style.display = show ? "inline" : "none";
}

function writeValueSelectTdWithMax( id, label, max ) {
	document.write( '<td><label class="hidden" for="' + id + '">' + label + '</label>' );
	document.write( '<select id="' + id + '">' );
	for ( let i=0; i<=max; ++i ) {
		document.write( '<option value=' + i + '>' + i + '</option>' );
    }
	document.write( '</select></td>' );
}
function writeValueSelectTd( id, label ) {
	writeValueSelectTdWithMax( id, label, 127 );
}

function writeCheckboxTd( id, label ) {
	document.write( '<td><label class="hidden" for="' + id + '">' + label + '</label>' );
	document.write( '<input type="checkbox" id="' + id + '" /></td>' );
}

function change14bit( id ) {
	var v = document.getElementById( id ).value;
	var vi = Number( v );
	if ( !( vi >= 0 && vi < 16384 ) ) {
		document.getElementById( id ).value = 0;
	}
}

function write14bitValueBoxTd( id, label ) {
	document.write( '<td><label class="hidden" for="' + id + '">' + label + '</label>' );
    document.write( "<input onchange='change14bit(\"" + id + "\")' type='text' id='" + id + "' min=0 max=16383 size=5 type='number' value='0'></td>" );
	document.write( '</td>' );
}
</script>

</head>

<body>

<div class="small">
At the time of writing this will work only in Google's <a href="http://www.google.com/chrome/">Chrome</a> browser or in the <a href="https://www.opera.com">Opera</a> browser. Chrome may block SysEx access if you run this from a website, in which case download the html file locally and run it from there.
</div>
<div class="warning">
This tool should be considered a beta release. Please report bugs and provide feedback via the <a href="https://www.modwiggler.com/forum/viewtopic.php?t=281529" target="_null">forum</a>.
</div>
<div class="small" id="status"></div>
<div class="small">
This version is for FH-2 firmware v1.23 and above.
<label for="theme">Theme: </label><select id="theme" onchange="changeTheme()"><option value=0>Light</option><option value=1>Dark</option></select>
</div>
<p>

<button class="big" accesskey='s' onclick="send()">Send to FH-2</button>
<label for="midioutput">Send to MIDI output port: </label><select id="midioutput" onchange="changeOutput()" accesskey='o'></select>
<button onclick="sendMsg()">Send Msg</button>
<br>
<button class="big" accesskey='u' onclick="request()">Upload from FH-2</button>
<label for="midiinput">Listen on MIDI input port: </label><select id="midiinput" onchange='changeInput()' accesskey='i'></select>
<button onclick="reqVersion()" accesskey='v'>Request FH-2 Version</button>
</p>
<div id='upload' class='upload'>
<label for="chooseConfig">Choose preset to load:</label><input type="file" id="chooseConfig" name="files[]" single />
<button onclick="loadConfig()">Load</button>
</div>
<div id='download' class='upload'>
<button onclick="prepareSaveConfig()">Generate preset to save</button>
<a id="saveConfig" download="preset.syx">Click to Save Preset</a>
</div>
<p>
<textarea rows=5 cols=50 id="log" class="log" readOnly title="Log" accesskey='l'></textarea>
<textarea rows=5 cols=48 name="text" id="txSysex" title="Transmitted SysEx"></textarea>
<textarea rows=5 cols=48 name="text" id="rxSysex" title="Received SysEx"></textarea>
<p>
<label for="config_name">Preset name:</label><input id='config_name' accesskey='n' type='text'>
<p>
<label class = 'hidden' for='glb_lbl'>Show Globals</label>
<input id='glb_lbl' type='checkbox' onclick='showHide("glb_table",this.checked);showHide("glb_table2",this.checked)' accesskey="b">Show Globals</input>
<label class = 'hidden' for='env_lbl'>Show Portamento/Transpose/Envelopes</label>
<input type='checkbox' id='env_lbl' onclick='showHide("env_table",this.checked)'  accesskey='p'>Show Portamento/Transpose/Envelopes</input>
<label class = 'hidden' for='arp_lbl'>Show Arpeggiators</label>
<input type='checkbox' id='arp_lbl' onclick='showHide("arp_table",this.checked)'  accesskey='a'>Show Arpeggiators</input>
<label class = 'hidden' for='trig_lbl'>Show Triggers</label>
<input type='checkbox' id='trig_lbl' onclick='showHide("trg_table",this.checked)' accesskey='t'>Show Triggers</input>
<label class = 'hidden' for='euc_lbl'>Show Euclidean Patterns</label>
<input type='checkbox' id='euc_lbl' onclick='showHide("euc_table",this.checked)' accesskey='r'>Show Euclidean Patterns</input>
<label class = 'hidden' for='sq_lbl'>Show Sequencers</label>
<input type='checkbox' id='sq_lbl' onclick='showHide("seq_table",this.checked)' accesskey='q'>Show Sequencers</input>
<br>
<label class="hidden" for="showfh2outputs">Show FH-2 Outputs</label>
<input id="showfh2outputs" type='checkbox' onclick='showHide("outs0_table",this.checked)' checked=true  accesskey='w'>Show FH-2 Output Configurator</input>
| Show FHX-8CV Expander Outputs:
<script>
	var i;
	for ( i = 1; i < 8; ++i ) {
		document.write( "<label class='hidden' for='show8cvoutputs" + i + "'>Show FHX-8CV Expander Output Configurator " + i + "</label><input id='show8cvoutputs" + i + "' type='checkbox' accesskey='" + i + "' onclick='showHide(\"outs" + i + "_table\",this.checked)'>" + i + "</input>" );
	}
</script>
<label class = 'hidden' for='srr_lbl'>Show SR Random</label>
<input type='checkbox' id='srr_lbl' onclick='showHide("srr_table",this.checked)' accesskey='s'>Show SR Random</input>

<table id="glb_table"><caption class="hidden">Globals</caption>
<thead>
<tr class="a">
<th>Tempo</th>
<th colspan=5>Swing</th>
</tr>
<tr class="a">
<th></th>
<th>Type</th><th>Amount</th><th>Position 1</th><th>Position 2</th><th>Position 3</th>
</tr>
</thead>
<tbody>
<tr class="a">
<td><label class="hidden" for="tempo">Tempo</label><input id='tempo' min=0 max=999.99 size=5 type='number' value='0'></td>
<td><label class="hidden" for="swing_type">Swing Type</label><select id='swing_type'>
<option value=0>Off</option>
<option value=1>16th note</option>
<option value=2>8th note</option>
<option value=3>Pentuplet</option>
<option value=4>Sextuplet</option>
<option value=5>Septuplet</option>
<option value=6>Octuplet</option>
<option value=7>Nonuplet</option>
</select></td>
<script>
writeValueSelectTd( 'swing_amount', 'Swing Amount' );
writeValueSelectTd( 'swing_pos1', 'Swing Position 1' );
writeValueSelectTd( 'swing_pos2', 'Swing Position 2' );
writeValueSelectTd( 'swing_pos3', 'Swing Position 3' );
</script>
</tr>
</tbody>
</table>

<table id="glb_table2"><caption class="hidden">Globals</caption>
<thead>
</thead>
<tbody>
</tbody>
</table>

<table id="env_table"><caption class="hidden">Portamento, Transposition and Envelopes</caption>
<thead>
<tr>
<th></th>
<th>Portamento</th>
<th>Transpose</th>
<th colspan=7>Envelopes</th>
<th>Random</th>
<th colspan=3>Scala</th>
</tr>
<tr>
<th></th>
<th></th>
<th></th>
<th>Attack</th><th>Decay</th><th>Sustain</th><th>Release</th><th>Range</th><th>Depth</th><th>Velocity Depth</th>
<th></th>
<th>Enable</th><th>.scl</th><th>.kbm</th>
</tr>
</thead>
<script>
	for ( i = 0; i < 16; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );

		for ( var j=0; j<arpControlsUI.length; ++j ) {
			var id = "arpeg" + i + "_" + arpControlsUI[j];
			var param_label;

if (j == 0)
{
param_label = "portamento";
}
else if (j == 1)
{
param_label = "transpose";
}
else
{
param_label = "error: unknown parameter";
}

			writeValueSelectTd( id, param_label );
		}
		for ( var j=0; j<mcvMappable2Controls.length; ++j ) {
			var id = "mcvm2_" + i + "_" + mcvMappable2Controls[j];
			var param_label;

if (j == 0)
{
param_label = "env. attack";
}
else if (j == 1)
{
param_label = "env. decay";
}
else if (j == 2)
{
param_label = "env. sustain";
}
else if (j == 3)
{
param_label = "env. release";
}
else if (j == 4)
{
param_label = "env. range";
}
else if (j == 5)
{
param_label = "env. depth";
}
else if (j == 6)
{
param_label = "env. velocity depth";
}
else if (j == 7)
{
param_label = "random depth";
}
else
{
param_label = "error: unknown parameter";
}

			writeValueSelectTd( id, param_label );
		}
    	writeValueSelectTd( "scala_" + i + "_enable", "Scala enable" );
    	writeValueSelectTd( "scala_" + i + "_scl", "Scala .scl" );
    	writeValueSelectTd( "scala_" + i + "_kbm", "Scala .kbm" );
		document.write( "</tr>" );
	}
</script>
</table>

<table id="arp_table"><caption class="hidden">Arpeggiators</caption>
<thead>
<tr>
<th colspan=7>Arpeggiator</th>
</tr>
<tr>
<td></td>
<th>Mode</th><th>Range</th><th>Gate Length</th><th>Latch</th><th>Rate</th><th>Reset</th>
</tr>
</thead>
<script>
	for ( i = 0; i < 16; ++i ) {
		var cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		for ( var j=0; j<arpControlsUI2.length; ++j ) {
			var id = "arpeg" + i + "_" + arpControlsUI2[j];
			var param_label;

if (j == 0)
{
param_label = "arp. mode";
}
else if (j == 1)
{
param_label = "arp. range";
}
else if (j == 2)
{
param_label = "arp. gate length";
}
else if (j == 3)
{
param_label = "arp. latch";
}
else if (j == 4)
{
param_label = "arp. rate";
}
else if (j == 5)
{
param_label = "arp. reset";
}
else
{
param_label = "error: unknown parameter";
}

			writeValueSelectTd( id, param_label );
		}
		document.write( "</tr>" );
	}
</script>
</table>

<table id="trg_table"><caption class="hidden">Triggers</caption>
<tr>
<th colspan=64>Triggers/Gates</th>
</tr>
<script>
	document.write( "<tr class=a>" );
	for ( let i=0; i<64; ++i ) {
		document.write( "<th>" + (i+1) + "</th>" );
	}
	document.write( "</tr><tr class=b>" );
	for ( let i=0; i<64; ++i ) {
		writeCheckboxTd( "trig_" + i, "Trigger " + (i+1) );
	}
	document.write( "</tr>" );
</script>
</table>

<table id="euc_table"><caption class="hidden">Euclidean Patterns</caption>
<tr>
<th colspan=8>Euclidean Patterns</th>
</tr>
<tr><td></td>
<th>Pulses</th><th>Steps</th><th>Rotation</th><th>Rate</th><th>Gate Length</th><th>Accent Rate</th><th>Reset</th>
</tr>
<script>
	for ( i = 0; i < 16; ++i ) {
		var cl = ( i & 1 ) ? "b" : "a";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		id = "euc_output_" + i;
		for ( var j=0; j<eucControls.length; ++j ) {
			var param_label;
			var id = "euc_" + i + "_" + eucControls[j];

			if (j == 0)
{
param_label = "Pulses";
}
else if (j == 1)
{
param_label = "Steps";
}
else if (j == 2)
{
param_label = "Rotation";
}
else if (j == 3)
{
param_label = "Rate";
}
else if (j == 4)
{
param_label = "Gate Length";
}
else if (j == 5)
{
param_label = "Accent Rate";
}
else if (j == 6)
{
param_label = "Reset";
}
else
{
param_label = "error: unknown parameter";
}

			writeValueSelectTd( id, param_label );
		}
	}
</script>
</table>

<table id="srr_table"><caption class="hidden">Shift Register Random</caption>
<tr>
<th colspan=9>Shift Register Random</th>
</tr>
<tr><td></td>
<th>Direction</th><th>Length</th><th>Randomness</th><th>Rate</th><th>Attenuator</th><th>Scale</th><th>Key</th>
<th>Gate Length</th>
</tr>
<script>
	for ( i = 0; i < 16; ++i ) {
		var cl = ( i & 1 ) ? "b" : "a";
		document.write( "<tr class=" + cl + "><td>" + i + "</td>" );

		for ( var j=0; j<srrControls.length; ++j ) {
			var param_label = "";
			var id = "srr_" + i + "_" + srrControls[j];
			writeValueSelectTd( id, param_label );
		}
	}
</script>
</table>

<table id="seq_table"><caption class="hidden">Sequencers</caption>
<tr>
<th>Sequencers</th>
</tr>
<tr><td><table class='nested'>
<tr><th>Note sequencers</th></tr>
<script>
	var seqControls = [ "A", "E", "T", "S", "G", "N", "D", "P" ];
	var seqControlLabels = [ "start", "end", "rate", "reset", "gate length", "root note", "direction", "permutation" ];
	var seqControlMax = [ 31, 31, 127, 127, 127, 127, 7, 31 ];
	for ( let i=0; i<4; ++i ) {
		let cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		document.write( "<td><table>" );
		document.write( "<tr><th>Active</th><th>Mute</th><th>Start</th><th>End</th><th>Rate</th><th>Reset</th><th>Gate Length</th><th>Root Note</th><th>Direction</th><th>Permutation</th></tr><tr>" );
		writeCheckboxTd( "seq_" + i + "_active", "Sequencer " + (i+1) + " active" );
		writeCheckboxTd( "seq_" + i + "_mute", "Sequencer " + (i+1) + " mute" );
		for ( let j=0; j<seqControls.length; ++j ) {
			let id = "seq_" + i + "_" + seqControls[j];
			let param_label = seqControlLabels[j];
			writeValueSelectTdWithMax( id, param_label, seqControlMax[j] );
		}
		document.write( "</tr></table><tr><td></td><td><table><tr>" );
		for ( j=0; j<32; ++j ) {
			document.write( "<th colspan=8>" + (j+1) + "</th>" );
		}
		document.write( "</tr><tr>" );
		for ( j=0; j<32; ++j ) {
			document.write( "<td><table>" );
			for ( let k=7; k>=0; k-- ) {
				document.write( "<tr><td><select id=seq_" + i + "_" + j + "_" + k + "><option value=0>--</option><option value=1>On</option><option value=2>Tie</option></select></td></tr>" );
			}
			document.write( "</table></td>" );
			writeValueSelectTdWithMax( "seq_" + i + "_" + j + "_degree", "step", 15 );
			writeValueSelectTdWithMax( "seq_" + i + "_" + j + "_octave", "octave", 7 );
			writeCheckboxTd( "seq_" + i + "_" + j + "_skip", "skip" );
			writeValueSelectTdWithMax( "seq_" + i + "_" + j + "_length", "length", 7 );
			writeCheckboxTd( "seq_" + i + "_" + j + "_ratchet", "ratchet" );
			writeCheckboxTd( "seq_" + i + "_" + j + "_reset", "reset" );
			writeValueSelectTdWithMax( "seq_" + i + "_" + j + "_mute", "mute", 7 );
		}
		document.write( "</tr></table></td></tr>" );
	}
</script>
</table></td></tr>
<tr><td><table class='nested'>
<tr><td></td><th colspan=3>Global</th>
<tr><th>Drum sequencers</th></tr>
<script>
	var dseqControls = [ "S" ];
	var dseqlControls = [ "A", "E", "T", "S", "M" ];
	var dseqControlLabels = [ "reset" ];
	var dseqlControlLabels = [ "start", "end", "rate", "reset", "mute" ];
	var dseqlControlMax = [ 31, 31, 127, 127, 1 ];
	for ( let i=0; i<1; ++i ) {
		let cl = ( i & 1 ) ? "a" : "b";
		document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
		document.write( "<td><table><tr><th>Active</th><th>Mute</th><th>Reset</th></tr><tr>" )
		writeCheckboxTd( "dseq_" + i + "_active", "Drum sequencer " + (i+1) + " active" );
		writeCheckboxTd( "dseq_" + i + "_mute", "Drum sequencer " + (i+1) + " mute" );
		for ( let j=0; j<dseqControls.length; ++j ) {
			let id = "dseq" + i + "_" + dseqControls[j];
			let param_label = dseqControlLabels[j];
			writeValueSelectTd( id, param_label );
		}
    	document.write( "</tr></table></td></tr>" );
		for ( let k=0; k<8; ++k ) {
	    	document.write( "<tr rowspan=2><th>Lane " + (1+k) + "</th><td><table>" );
			document.write( "<tr><th>Start</th><th>End</th><th>Rate</th><th>Reset</th><th>Mute</th></tr><tr>" );
			for ( let j=0; j<dseqlControls.length; ++j ) {
				let id = "dseq" + i + "_" + k + "_" + dseqlControls[j];
				let param_label = dseqlControlLabels[j];
				let max = dseqlControlMax[j];
				if ( max == 1 ) {
					writeCheckboxTd( id, param_label );
				} else {
					writeValueSelectTdWithMax( id, param_label, max );
				}
			}
			document.write( "</tr></table></td></tr><tr><td></td><td><table><tr>" );
			for ( j=0; j<32; ++j ) {
				document.write( "<th>" + (j+1) + "</th>" );
			}
			document.write( "</tr><tr>" );
			for ( j=0; j<32; ++j ) {
    			writeCheckboxTd( "dseqa" + i + "_" + k + "_" + j, "accent" );
			}
			document.write( "</tr><tr>" );
			for ( j=0; j<32; ++j ) {
    			writeCheckboxTd( "dseqh" + i + "_" + k + "_" + j, "hit" );
			}
			document.write( "</tr></table></td></tr>" );
		}
	}
</script>
</table></td></tr>
</table>

<script>
	var ac = [ "DC", "LFO", "CLK", "CLKM", "MUS", "MLT", "SIN", "SQR", "PW", "TRI", "SAW", "RND", "NSE", "PHS", "FAD", "SMO" ];
	var labels = [ "Direct level", "LFO speed", "Clocked base", "Clocked multiplier", "Use musical", "LFO Level", "Sine", "Square", "PW", "Triangle", "Saw", "Random", "Noise", "Phase", "Fade", "Smoothing" ];

	var id;
	var x;
	for ( x = 0; x < 8; ++x ) {

		document.write( "<table id='outs" + x + "_table'>" );
		document.write( "<tr><th colspan=3>" + ( x ? ( "Expander " + x ) : "FH-2" ) + "</th><th colspan=3>LFO Tempo-based</th>" );
		document.write( "<th colspan=10>LFO</th>" );
		document.write( "<th colspan=1>" + ( x ? ( "Expander " + x ) : "FH-2" ) + "</th></tr>" );
		document.write( "<tr><th>Output</th><th>Direct Level</th><th>LFO Speed</th><th>Base</th><th>Multiplier</th><th>Use</th><th>LFO Level</th>" );
		document.write( "<th>Sine</th><th>Square</th><th>PW</th><th>Triangle</th><th>Saw</th>" );
		document.write( "<th>Random</th><th>Noise</th><th>Phase</th><th>Fade</th>" );
		document.write( "<th>Smoothing</th>" );
		document.write( "</tr>" );
	
		for ( i = 0; i < 8; ++i ) {
			var cl = ( i & 1 ) ? "a" : "b";
			document.write( "<tr class=" + cl + "><td>" + (i+1) + "</td>" );
			var out = x * 8 + i;

			for ( j=0; j<ac.length; ++j ) {
				var id = "out_" + out + "_" + ac[j];
				var param_label = labels[j];
				if ( j <= 1 || j == 5 ) {
					write14bitValueBoxTd( id, param_label );
				} else if ( j == 4 ) {
					writeCheckboxTd( id, param_label );
				} else {
					writeValueSelectTd( id, param_label );
				}
			}

			document.write( "</tr>" );
		}
		
		document.write( "</table>" );
		if ( x > 0 ) {
			showHide( "outs" + x + "_table", false );
		}
	}

</script>

<script>
showHide( "glb_table", false );
showHide( "glb_table2", false );
showHide( "env_table", false );
showHide( "arp_table", false );
showHide( "trg_table", false );
showHide( "euc_table", false );
showHide( "srr_table", false );
showHide( "seq_table", false );
</script>

<script>
function parsePresetDump( data ) {
	let c = 0;
	// version
	let version = ( data[c] ) | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
	if ( version != 7 )
	{
		alert( "This version of the tool does not match the FH-2 firmware." );
		return;
	}
	c += 4;
	// name
	let name = "";
	let i;
	for ( i = 0; i < 16; ++i ) {
		var n = data[c+i];
		if ( n == 0 ) {
			break;
		}
		name += String.fromCharCode( n );
	}
	document.getElementById( "config_name" ).value = name;
	c += 17;
	// globals
	document.getElementById( "swing_type" ).value = data[c];	c += 1;
	document.getElementById( "swing_amount" ).value = data[c];	c += 1;
	c += 1;
	// fader levels
	for ( i = 0; i < 64; ++i ) {
		let v = unSysexSafeShort( data[c+0] | ( data[c+1] << 8 ) );
		document.getElementById( "out_" + i + "_DC" ).value = v;
		c += 2;
	}
	// LFOs
	for ( i = 0; i < 64; ++i ) {
		let v = unSysexSafeShort( data[c+0] | ( data[c+1] << 8 ) );
		document.getElementById( "out_" + i + "_MLT" ).value = v;
		c += 2;
		v = unSysexSafeShort( data[c+0] | ( data[c+1] << 8 ) );
		document.getElementById( "out_" + i + "_LFO" ).value = v;
		c += 2;
		document.getElementById( "out_" + i + "_CLK" ).value = data[c];		c += 1;
		document.getElementById( "out_" + i + "_CLKM" ).value = data[c];	c += 1;

		document.getElementById( "out_" + i + "_SIN" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_SQR" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_TRI" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_PW" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_SAW" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_RND" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_NSE" ).value = data[c];	c += 1;

		document.getElementById( "out_" + i + "_FAD" ).value = data[c];	c += 1;
		document.getElementById( "out_" + i + "_MUS" ).checked = data[c];	c += 1;
		document.getElementById( "out_" + i + "_PHS" ).value = data[c];	c += 1;
	}
	// smoothing
	for ( i = 0; i < 64; ++i ) {
		document.getElementById( "out_" + i + "_SMO" ).value = data[c];	c += 1;
	}
	// MCV mappable
	for ( i = 0; i < 16; ++i ) {
		document.getElementById( "arpeg" + i + "_M" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_R" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_G" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_L" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_T" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_P" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_S" ).value = data[c];	c += 1;
		document.getElementById( "arpeg" + i + "_E" ).value = data[c];	c += 1;
	}
	// globals
   	let v = unSysexSafeInt( data[c+0] | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 ) );
	document.getElementById( "tempo" ).value = v * 0.1;
	c += 4;
	// euclidean
	for ( i = 0; i < 16; ++i ) {
		document.getElementById( "euc_" + i + "_P" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_S" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_R" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_T" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_G" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_A" ).value = data[c];	c += 1;
		document.getElementById( "euc_" + i + "_E" ).value = data[c];	c += 1;
		c += 1;
	}
	// MCV mappable 2
	for ( i = 0; i < 16; ++i ) {
		document.getElementById( "mcvm2_" + i + "_A" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_D" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_S" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_R" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_N" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_P" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_V" ).value = data[c];	c += 1;
		document.getElementById( "mcvm2_" + i + "_RND" ).value = data[c];	c += 1;
	}
	// scala
	for ( i = 0; i < 16; ++i ) {
		document.getElementById( "scala_" + i + "_enable" ).value = data[c];	c += 1;
		document.getElementById( "scala_" + i + "_scl" ).value = data[c];		c += 1;
		document.getElementById( "scala_" + i + "_kbm" ).value = data[c];		c += 1;
		c += 1;
	}
	// sequencer active/mute
	let sa = data[c];	c += 1;
	let sm = data[c];	c += 1;
	for ( i = 0; i < 4; ++i ) {
		document.getElementById( "seq_" + i + "_active" ).checked = ( sa >> i ) & 1;
		document.getElementById( "seq_" + i + "_mute" ).checked = ( sm >> i ) & 1;
	}
	let da = data[c];	c += 1;
	let dm = data[c];	c += 1;
	for ( i = 0; i < 1; ++i ) {
		document.getElementById( "dseq_" + i + "_active" ).checked = ( da >> i ) & 1;
		document.getElementById( "dseq_" + i + "_mute" ).checked = ( dm >> i ) & 1;
	}
	// triggers
	c += 8;
	// seqencers
	let patterns = [ [], [], [], [] ];
	for ( i = 0; i < 4; ++i ) {
		let pattern = [];
		for ( let j=0; j<32; ++j ) {
			let v = unSysexSafeShort( data[c+0] | ( data[c+1] << 8 ) );
			pattern[j] = v;
			c += 2;
			let v0 = data[c];	c += 1;
			let v1 = data[c];	c += 1;
			document.getElementById( "seq_" + i + "_" + j + "_degree" ).value = v0 & 0xf;
			document.getElementById( "seq_" + i + "_" + j + "_octave" ).value = ( v0 >> 4 ) & 0x7;
			document.getElementById( "seq_" + i + "_" + j + "_length" ).value = v1 & 0x7;
			document.getElementById( "seq_" + i + "_" + j + "_ratchet" ).checked = ( v1 >> 3 ) & 1;
			document.getElementById( "seq_" + i + "_" + j + "_reset" ).checked = ( v1 >> 4 ) & 1;
		}
		document.getElementById( "seq_" + i + "_A" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_E" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_T" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_G" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_S" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_N" ).value = data[c];	c += 1;
		document.getElementById( "seq_" + i + "_D" ).value = data[c];	c += 1;
		c += 1;
		patterns[i] = pattern;
	}
	// drum seqencers
	for ( i = 0; i < 1; ++i ) {
		for ( let j=0; j<8; ++j ) {
			let h = data[c+0] | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
			c += 4;
			let a = data[c+0] | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
			c += 4;
			for ( let m=0; m<4; ++m ) {
				for ( let n=0; n<4; ++n ) {
	    			document.getElementById( "dseqa" + i + "_" + j + "_" + (m*8+n) ).checked = ( a >> (m*8+n) ) & 1;
    				document.getElementById( "dseqh" + i + "_" + j + "_" + (m*8+n) ).checked = ( h >> (m*8+n) ) & 1;
    			}
			}
			document.getElementById( "dseq" + i + "_" + j + "_A" ).value = data[c];	c += 1;
			document.getElementById( "dseq" + i + "_" + j + "_E" ).value = data[c];	c += 1;
			document.getElementById( "dseq" + i + "_" + j + "_T" ).value = data[c];	c += 1;
			document.getElementById( "dseq" + i + "_" + j + "_S" ).value = data[c];	c += 1;
			document.getElementById( "dseq" + i + "_" + j + "_M" ).checked = data[c];	c += 1;
			c += 3;
		}
		document.getElementById( "dseq" + i + "_S" ).value = data[c];	c += 1;
		c += 15;
	}
	// shift reg random
	for ( i = 0; i < 16; ++i ) {
		document.getElementById( "srr_" + i + "_D" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_L" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_R" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_T" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_A" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_S" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_K" ).value = data[c];	c += 1;
		document.getElementById( "srr_" + i + "_G" ).value = data[c];	c += 1;
	}
	// swing
	document.getElementById( "swing_pos1" ).value = data[c];	c += 1;
	document.getElementById( "swing_pos2" ).value = data[c];	c += 1;
	document.getElementById( "swing_pos3" ).value = data[c];	c += 1;
	c += 1;

	// skip to addendum
	c = 4096;

	// triggers	
	for ( i = 0; i < 16; ++i ) {
		let v = data[c]; 	c += 1;
		for ( let j=0; j<4; ++j ) {
			document.getElementById( "trig_" + (i*4+j) ).checked = ( v >> j ) & 1;
		}
	}
	// seqencers
	for ( i = 0; i < 4; ++i ) {
		document.getElementById( "seq_" + i + "_P" ).value = data[c];	c += 1;
    	let pattern = patterns[i];
		for ( let j=0; j<32; ++j ) {
			let v0 = data[c];	c += 1;
			let v1 = data[c];	c += 1;
			let p = pattern[j];
			p = p | ( v0 << 14 );
			document.getElementById( "seq_" + i + "_" + j + "_skip" ).checked = v1 & 1;
			document.getElementById( "seq_" + i + "_" + j + "_mute" ).value = ( v1 >> 1 ) & 0x7;
			for ( let k=0; k<8; ++k ) {
				document.getElementById( "seq_" + i + "_" + j + "_" + k ).value = ( p >> (2*k) ) & 3;
			}
		}
	}
	// drum seqencers
	for ( i = 0; i < 1; ++i ) {
		for ( let j=0; j<8; ++j ) {
			let h = data[c+0] | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
			c += 4;
			let a = data[c+0] | ( data[c+1] << 8 ) | ( data[c+2] << 16 ) | ( data[c+3] << 24 )
			c += 4;
			for ( let m=0; m<4; ++m ) {
				for ( let n=0; n<4; ++n ) {
	    			document.getElementById( "dseqa" + i + "_" + j + "_" + (m*8+4+n) ).checked = ( a >> (m*8+n) ) & 1;
    				document.getElementById( "dseqh" + i + "_" + j + "_" + (m*8+4+n) ).checked = ( h >> (m*8+n) ) & 1;
    			}
			}
		}
	}
}
</script>

<script>
var midi, data;
function onMIDISuccess(midiAccess) {
	log( "midi access granted" );
    status("OK");
    midi = midiAccess;
    midi.onstatechange = onStateChange;
    onStateChange(null);
}
function onStateChange(e) {
    var str = "";
    var fh2 = -1;
    var inputs = midi.inputs.values();
    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
	    str += "<option value='" + input.value.id + "'>" + input.value.name + "</option>";
	    if ( input.value.name == fh2InPortName ) {
		    fh2 = input.value.id;
	    }
    }
    document.getElementById( "midiinput" ).innerHTML = str
    if ( fh2 != -1 ) {
	    document.getElementById( "midiinput" ).value = fh2;
    }
    str = "";
    fh2 = -1;
    var outputs = midi.outputs.values();
    for ( var output = outputs.next(); output && !output.done; output = outputs.next() ) {
	    str += "<option value='" + output.value.id + "'>" + output.value.name + "</option>";
	    if ( output.value.name == fh2OutPortName ) {
		    fh2 = output.value.id;
			midi.outputs.get( output.value.id ).send( [ 0xFE ] );
	    }
    }
    document.getElementById( "midioutput" ).innerHTML = str
    if ( fh2 != -1 ) {
	    document.getElementById( "midioutput" ).value = fh2;
    }

	setup_onmidimessage();
}
function onMIDIFailure(e) {
	log( "midi access failure" );
    status("No access to MIDI devices or your browser doesn't support WebMIDI API.");
}
function setup_onmidimessage() {
    var inputs = midi.inputs.values();
    if ( inputs.size == 0 ) {
    	return;
    }
    for ( var input = inputs.next(); input && !input.done; input = inputs.next() ) {
    	input.value.onmidimessage = "";
    }
	var input = midi.inputs.get( document.getElementById( "midiinput" ).value );
	input.onmidimessage = onMIDIMessage;
}
function changeInput() {
	setup_onmidimessage();
	// Save the current port settings
	let inputSelector = document.getElementById("midiinput"); 
	let selectedPortName = inputSelector.options[inputSelector.selectedIndex].text;
    localStorage.setItem(fh2MIDIInKey, selectedPortName);
}
function changeOutput() {
	var outputSelector = document.getElementById("midioutput"); 
	var selectedPortName = outputSelector.options[outputSelector.selectedIndex].text;
    localStorage.setItem(fh2MIDIOutKey, selectedPortName);
}
function onMIDIMessage(message) {
    data = message.data;
    var header = [ 240, 0, 33, 39, 47 ];
    for ( var i=0; i<5; ++i ) {
    	if ( header[i] != data[i] ) {
    		return;
    	}
    }
	var dd = log( "received sysex (" + data.length + " bytes)" );
	dumpSysex( data, "rxSysex", dd+"\n" );
	if ( data[5] == 0x32 ) {
		// version string
	    var str = String.fromCharCode.apply( null, data.slice( 6, -1 ) );
		document.getElementById( "rxSysex" ).value += ( "\n-----\n" + str );
	}
	else if ( data[5] == 0x13 ) {
		// preset dump
		parsePresetDump( data.slice( 8, -1 ) );
	}
}
function send() {
	let arr = makeSysEx();
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	let dd = log( "sent sysex (" + arr.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function sendMsg() {
	let str = makeMsgSysEx();
	let arr = new Uint8Array( str.length );
	for ( let i=0; i<str.length; ++i ) {
		arr[i] = str.charCodeAt( i );
	}
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	output.send( arr );
	let dd = log( "sent sysex (" + str.length + " bytes)" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function request() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x2F, 0x23, 0xF7 ];
	output.send( arr );
	let dd = log( "sent preset dump request to FH-2" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
function reqVersion() {
	let output = midi.outputs.get( document.getElementById( "midioutput" ).value );
	let arr = [ 0xF0, 0x00, 0x21, 0x27, 0x2F, 0x22, 0xF7 ];
	output.send( arr );
	let dd = log( "sent version request to FH-2" );
	dumpSysex( arr, "txSysex", dd+"\n" );
}
var chosenConfig = []
function handleFileSelect(evt,id) {
	let files = evt.target.files; // FileList object
	let f = files[0];

	var reader = new FileReader();

	reader.onload = (function(theFile) {
		return function(e) {
			let ints = new Uint8Array( e.target.result );
			let arr = Array.from( ints ) ;
			chosenConfig = [];
			if ( arr.length < 7
				|| arr[0] != 0xF0
				|| arr[1] != 0x00
				|| arr[2] != 0x21
				|| arr[3] != 0x27
				|| arr[4] != 0x2F
				|| arr[5] != 0x13
				|| arr[arr.length-1] != 0xF7 ) {
				alert( "Not a valid preset dump file" );
				console.log( arr );
			} else {
				chosenConfig = arr;
			}
		};
	  })(f);
  
	reader.readAsArrayBuffer( f );
}
document.getElementById('chooseConfig').addEventListener('change', handleFileSelect, false);
function loadConfig() {
	if ( chosenConfig.length >= 7 ) {
		parsePresetDump( chosenConfig.slice( 8, -1 ) );
    	let dd = log( "loaded preset from file" );
	}
}
var configBlob = null;
function prepareSaveConfig() {
	let data = makeSysEx();
	configBlob = new Blob([data], {type: "application/octet-stream"});
	let url = window.URL.createObjectURL(configBlob);
	document.getElementById( "saveConfig" ).href = url;
	document.getElementById( 'saveConfig' ).style.display = "inline";
}
function makeDownloadInvalid() {
	document.getElementById( 'saveConfig' ).style.display = "none";
}

const fh2MIDIInKey = "fh2MIDIInKey";
const fh2MIDIOutKey = "fh2MIDIOutKey";
const defaultFH2PortName = "FH-2";
var fh2InPortName = defaultFH2PortName;
var fh2OutPortName = defaultFH2PortName;

if(!localStorage.getItem(fh2MIDIInKey)) {  // No input stored
    localStorage.setItem(fh2MIDIInKey, defaultFH2PortName);
} 
else {
    fh2InPortName = localStorage.getItem(fh2MIDIInKey);
}

if(!localStorage.getItem(fh2MIDIOutKey)) {  // No output stored
    localStorage.setItem(fh2MIDIOutKey, defaultFH2PortName);
} 
else {
    fh2OutPortName = localStorage.getItem(fh2MIDIOutKey);
}

const themeKey = 'fh2Theme';
if ( localStorage.getItem( themeKey ) ) {
	if ( localStorage.getItem( themeKey ) == 1 ) {
		document.getElementById( "theme" ).value = 1;
		changeTheme();
	}
}

if ( navigator.requestMIDIAccess ) {
    navigator.requestMIDIAccess ( {
        sysex: true
    } ).then(onMIDISuccess, onMIDIFailure);
} else {
    status("No MIDI support in your browser.");
}

</script>

</body>
